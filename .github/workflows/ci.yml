name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: "http://localhost"
      SUPABASE_ANON_KEY: "test-anon-key"
      SKIP_ENV_VALIDATION: "1"
      TELEGRAM_BOT_TOKEN: "test-token"
      TELEGRAM_WEBHOOK_URL: "http://localhost:8000/webhook/telegram"
      TELEGRAM_WEBHOOK_SECRET: "test-secret"

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-asyncio

    - name: Run tests
      run: |
        pytest -q

# Optional: add a deploy step using Render CLI if you add RENDER_API_KEY and RENDER_SERVICE_ID as secrets
#  deploy:
#    runs-on: ubuntu-latest
#    needs: [test]
#    steps:
#    - uses: actions/checkout@v4
#    - name: Install Render CLI
#      run: curl -sSfL https://github.com/render-oss/cli/releases/download/v1.1.0/cli_1.1.0_linux_amd64.zip -o render.zip && unzip render.zip && sudo mv cli_v1.1.0 /usr/local/bin/render
#    - name: Trigger render deploy
#      env:
#        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
#      run: render deploys create ${{ secrets.RENDER_SERVICE_ID }} --wait --output json
